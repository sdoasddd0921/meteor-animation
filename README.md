# meteor-animation
模拟腾讯云首页banner的流星的动画。

## 现状

- 参照 `code pen`上面一些比较成熟的流星绘制的方式绘制出了流星，方法是绘制一条不透明的线段表示流星头，**下一帧给整个`canvas`覆盖一层半透明层来淡化上一帧绘制的流星**,接着再绘制新的流星头。随着半透明层的增多，越早绘制的流星会变得越淡直至消失看不见，然而如果半透明层的透明度没控制好的话，在流星走过之后会留下一条浅色的痕迹，流星多了以后会让背景变“花”。

- 流星到达目的地之后的闪烁动画，是由一个`Star`类实现的，每个实例会单独使用一个`requestAnimationFrame`来绘制，为了绘制出淡化透明度的效果，需要删除上一帧绘制的内容，下一帧降低透明度之后再绘制。由于和流星的`requestAnimationFrame`分离了，导致每个闪烁星星的实例在绘制是会删除周围的内容导致流星在星星附近会消失的Bug。

- 之后对闪烁的星星做了改进：`Star`类只保存坐标和透明度的信息，单独用一个`requestAnimationFrame`来绘制所有的星星。在每一帧遍历并读取星星数组里的星星，根据星星实例保存的数据状态绘制出所有的星星，每一帧之后每一颗星星应该根据一个随机数计算得到的透明度衰减值减少自己的透明度，以此来产生时间上错乱闪烁的星星的效果。

## 解决、优化思路

- 首先，所有的动画应该在同一个`requestAnimationFrame`中绘制，所以应该像上面改进之后的闪烁的星星的画法一样，**每一帧在绘制之前应该清空当前的绘制区域，然后在当前帧绘制出所有元素当前的状态。**所以需要想办法将流星和星星用同一个循环来绘制。
- 同样由改进后的星星产生的思路：流星也应该由类创建，并且实例需要保存自身每一个时刻的状态，**因此绘制流星不能依赖历史帧的画面。**
- 流星实例的数据就没有闪烁的星星那么简单了。稍微分析下：也是借鉴一篇文章中的思路，一条流星是由多条线段组成的，这些线段是有规律的，他们使用同样的颜色，长度相等，唯一的区别就是透明度随时间的推移会越来越淡。
  因此需要保存流星的“尾巴”的数量，将每一个需要绘制的点存入一个数组，并按照先后存入顺序给定相应的透明度。
  但是需要考虑流星的3个状态：

  - 流星刚出来的时候，这时候只有透明度为x(x>0)~1的线段。

  - 流星完整出现的时候，有透明度为0~1的线段。

  - 流星结束的时候，只有透明度为0~x(x>0)的线段。
- 在流星结束的时候，调用生成流星的时候传入的回调函数，在流星结束的地方往星星数组推入一颗星星的实例，然后每一帧都会读取星星数组、流星数组中的数据进行绘制。
- 星星闪烁完成之后又往流星数组中推入一颗流星的实例，形成循环！